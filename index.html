<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasta Randevu Paneli</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3b82f6', // Mavi (Hasta iÃ§in)
                        secondary: '#22c55e', // YeÅŸil (Onay iÃ§in)
                    }
                }
            }
        }
    </script>
</head>
<body>

    <div id="app-container" class="min-h-screen p-4 sm:p-8 bg-gray-50 relative">
        <div class="text-center p-10 text-xl text-primary font-semibold">Uygulama yÃ¼kleniyor...</div>
    </div>
    
    <!-- Ã–zel Onay ModalÄ± Buraya Eklenecek -->
    <div id="modal-portal"></div>

    <!-- Firebase SDK'larÄ± -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- SABÄ°T TANIMLAMALAR ---
        const DEFAULT_FEE = 350; 
        const DOCTORS = [
            { id: 'doc1', name: 'Dr. Ahmet YÄ±lmaz', specialty: 'Kardiyoloji' },
            { id: 'doc2', name: 'Dr. Elif Kaya', specialty: 'Dermatoloji' },
            { id: 'doc3', name: 'Dr. Can Demir', specialty: 'Dahiliye' },
        ];
        const availableTimes = ['10:00', '11:00', '14:00', '15:00', '16:00'];

        // --- GLOBAL DEÄÄ°ÅKENLER VE FIREBASE BAÄLANTISI ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let patientInfo = {}; 
        let allAppointments = []; 
        
        const getCollectionPath = (collectionName) => {
            // Ortak veritabanÄ± yolu
            return `/artifacts/${appId}/public/data/${collectionName}`;
        };

        let appointmentsColRef = null;
        let patientsColRef = null;

        // --- YARDIMCI FONKSÄ°YONLAR ---

        const showMessage = (message, type = 'success') => {
            const container = document.getElementById('message-container');
            if (!container) return;
            
            const color = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
            container.innerHTML = `
                <div class="px-4 py-3 rounded relative border ${color} mb-4" role="alert">
                    <span class="block sm:inline">${message}</span>
                </div>
            `;
            setTimeout(() => { container.innerHTML = ''; }, 5000);
        };
        
        // Ã–zel Onay ModalÄ± (window.confirm yerine)
        const renderConfirmationModal = (message, onConfirm) => {
            const modalPortal = document.getElementById('modal-portal');
            if (!modalPortal) return;

            modalPortal.innerHTML = `
                <div id="custom-modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300">
                    <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                        <p class="text-lg font-semibold text-gray-800 mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                                HayÄ±r, VazgeÃ§
                            </button>
                            <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                                Evet, Ä°ptal Et
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const closeModal = () => {
                modalPortal.innerHTML = '';
            };

            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('modal-confirm-btn').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'Tarih BelirtilmemiÅŸ';
            try {
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' };
                return new Date(dateString).toLocaleDateString('tr-TR', options);
            } catch (e) {
                return dateString;
            }
        };
        
        const handleLogout = () => {
             signOut(auth).then(() => {
                renderRoleSelection();
            }).catch(error => {
                console.error("Ã‡Ä±kÄ±ÅŸ HatasÄ±:", error);
            });
        };

        // --- FIREBASE Ä°LK BAÅLATMA VE YETKÄ°LENDÄ°RME ---

        const initFirebase = async () => {
            try {
                // Firebase konfigÃ¼rasyon kontrolÃ¼ kaldÄ±rÄ±ldÄ± (KonfigÃ¼rasyonun Canvas tarafÄ±ndan saÄŸlandÄ±ÄŸÄ± varsayÄ±lÄ±r)
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                appointmentsColRef = collection(db, getCollectionPath('appointments'));
                patientsColRef = collection(db, getCollectionPath('patients'));

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        renderPatientPanel();
                        startPatientDataListeners();
                    } else {
                        userId = null;
                        if (initialAuthToken) {
                            try {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } catch (error) {
                                console.error("Token ile Auth hatasÄ±, role seÃ§im ekranÄ±na yÃ¶nlendiriliyor:", error);
                                // EÄŸer custom token baÅŸarÄ±sÄ±z olursa, role seÃ§im ekranÄ±na yÃ¶nlendir.
                                renderRoleSelection();
                            }
                        } else {
                            // Custom token yoksa, direkt role seÃ§im ekranÄ±na yÃ¶nlendir, kullanÄ±cÄ± anonim olarak giriÅŸ yapmalÄ±.
                            renderRoleSelection();
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase baÅŸlatma hatasÄ±:", error);
                document.getElementById('app-container').innerHTML = '<div class="text-center p-10 text-red-500">Uygulama baÅŸlatÄ±lamadÄ±. KonfigÃ¼rasyon hatasÄ± veya Canvas ortamÄ± eksik.</div>';
            }
        };

        // --- ROL SEÃ‡Ä°M EKRANI (SADECE HASTA GÄ°RÄ°ÅÄ° ODAGINDA) ---

        const renderRoleSelection = () => {
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gray-100 p-6">
                    <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-2xl border-t-8 border-primary">
                        <h2 class="text-3xl font-extrabold text-gray-800 mb-4 text-center">Randevu PortalÄ± GiriÅŸi</h2>
                        <p class="text-gray-600 mb-6 text-center">
                            KayÄ±t olmadan randevu oluÅŸturmak ve mevcut randevularÄ±nÄ±zÄ± takip etmek iÃ§in misafir olarak hemen giriÅŸ yapÄ±n.
                        </p>
                        <button 
                            id="patient-anon-login-btn" 
                            class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl transition duration-300 shadow-lg"
                        >
                            Anonim GiriÅŸ Yap ve Randevu Al
                        </button>
                        <p class="mt-4 text-sm text-gray-500 text-center">
                            Doktor iseniz, lÃ¼tfen Doktor Paneli uygulamasÄ±na gidin.
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('patient-anon-login-btn').addEventListener('click', handlePatientAnonLogin);
        };
        
        const handlePatientAnonLogin = async () => {
            const btn = document.getElementById('patient-anon-login-btn');
            btn.disabled = true;
            btn.textContent = 'GiriÅŸ YapÄ±lÄ±yor...';
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Anonim GiriÅŸ HatasÄ±:", error);
                showMessage("Anonim giriÅŸ baÅŸarÄ±sÄ±z. LÃ¼tfen tekrar deneyin.", 'error');
                btn.disabled = false;
                btn.textContent = 'Anonim GiriÅŸ Yap ve Randevu Al';
            }
        };

        // --- VERÄ° DÄ°NLEYÄ°CÄ°LERÄ° ---
        
        const startPatientDataListeners = () => {
            if (!db || !userId) return;

            // 1. Hasta Bilgilerini Dinle (isim ve telefon)
            const patientDocRef = doc(patientsColRef, userId);
            onSnapshot(patientDocRef, (docSnap) => {
                patientInfo = docSnap.exists() ? docSnap.data() : { name: '', phone: '' };
                updateBookingFormPatientInfo();
            }, (err) => console.error("Hasta Bilgisi Dinleme HatasÄ±:", err));

            // 2. Kendi RandevularÄ±nÄ± Dinle
            const q = query(
                appointmentsColRef,
                where('patientId', '==', userId) 
            );
            onSnapshot(q, (snapshot) => {
                allAppointments = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    createdAt: doc.data().createdAt?.toDate()?.toLocaleString('tr-TR') || 'N/A'
                })).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                updatePatientAppointmentsList();
                updateAvailableSlots();
            }, (err) => console.error("Hasta Randevu Listesi Dinleme HatasÄ±:", err));
        };

        // --- HASTA PANELÄ° ARAYÃœZÃœ ---

        const renderPatientPanel = () => {
            const appContainer = document.getElementById('app-container');
            const today = new Date().toISOString().split('T')[0];

            appContainer.innerHTML = `
                <div class="min-h-screen bg-gray-100 p-4 sm:p-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 max-w-6xl mx-auto">
                        <h1 class="text-4xl font-extrabold text-primary">ğŸ¥ Hasta Randevu PortalÄ±</h1>
                        <div class="mt-4 sm:mt-0 flex items-center space-x-4">
                            <span class="text-sm text-gray-600">Oturum ID: ${userId ? userId.substring(0, 8) + '...' : 'Anonim'}</span>
                            <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                                Ã‡Ä±kÄ±ÅŸ Yap
                            </button>
                        </div>
                    </div>
                    
                    <div id="message-container" class="max-w-6xl mx-auto"></div>

                    <div class="max-w-6xl mx-auto space-y-12">
                        <!-- Randevu OluÅŸturma Sekmesi -->
                        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl">
                            <h1 class="text-3xl font-bold text-primary">ğŸ—“ï¸ Yeni Randevu OluÅŸtur</h1>
                            <form id="booking-form" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                <!-- KiÅŸisel Bilgiler -->
                                <div class="md:col-span-2 space-y-4 p-4 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50">
                                    <h2 class="text-xl font-semibold text-gray-700">1. KiÅŸisel Bilgileriniz</h2>
                                    <input type="text" id="patient-name" name="name" placeholder="AdÄ±nÄ±z SoyadÄ±nÄ±z" required class="w-full px-4 py-3 border rounded-lg focus:ring-primary"/>
                                    <input type="tel" id="patient-phone" name="phone" placeholder="Telefon NumaranÄ±z (Ã–rn: 5xx xxx xx xx)" required class="w-full px-4 py-3 border rounded-lg focus:ring-primary"/>
                                </div>
                                <!-- Doktor SeÃ§imi -->
                                <div class="space-y-4">
                                    <h2 class="text-xl font-semibold text-gray-700">2. Doktor SeÃ§imi</h2>
                                    <select id="appointment-doctor-id" required class="w-full px-4 py-3 border rounded-lg bg-white focus:ring-primary">
                                        ${DOCTORS.map(d => `<option value="${d.id}">${d.name} (${d.specialty})</option>`).join('')}
                                    </select>
                                </div>
                                <!-- Tarih ve Saat SeÃ§imi -->
                                <div class="space-y-4">
                                    <h2 class="text-xl font-semibold text-gray-700">3. Randevu Tarihi ve Saati</h2>
                                    <input type="date" id="appointment-date" value="${today}" min="${today}" required class="w-full px-4 py-3 border rounded-lg focus:ring-primary"/>
                                    <select id="appointment-time" required class="w-full px-4 py-3 border rounded-lg bg-white focus:ring-primary">
                                        <!-- Slotlar JS ile dolacak -->
                                    </select>
                                </div>
                                <!-- Buton -->
                                <div class="md:col-span-2 pt-4">
                                    <p class="text-sm font-medium text-gray-600 mb-2 text-center">Randevu Ã–n Ãœcreti: <span class="font-bold text-lg text-secondary">${DEFAULT_FEE} TL</span></p>
                                    <button type="submit" id="booking-submit-btn" class="w-full bg-secondary hover:bg-green-700 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300">
                                        Randevuyu Onayla ve GÃ¶nder
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <hr class="border-gray-300" />
                        
                        <!-- RandevularÄ±m Sekmesi -->
                        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-2xl">
                            <h2 class="text-2xl font-bold text-primary border-b pb-2 mb-4">ğŸ“‹ Mevcut RandevularÄ±nÄ±z</h2>
                            <div id="patient-appointments-list">
                                <p class="text-center text-gray-500 py-4">Randevular yÃ¼kleniyor...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('booking-form').addEventListener('submit', handleBooking);
            
            document.getElementById('appointment-doctor-id').addEventListener('change', updateAvailableSlots);
            document.getElementById('appointment-date').addEventListener('change', updateAvailableSlots);

            updateBookingFormPatientInfo();
            updateAvailableSlots();
        };

        const updateBookingFormPatientInfo = () => {
            const nameInput = document.getElementById('patient-name');
            const phoneInput = document.getElementById('patient-phone');
            if (nameInput) nameInput.value = patientInfo.name || '';
            if (phoneInput) phoneInput.value = patientInfo.phone || '';
        };

        const updateAvailableSlots = () => {
            const timeSelect = document.getElementById('appointment-time');
            const selectedDoctorId = document.getElementById('appointment-doctor-id')?.value;
            const selectedDate = document.getElementById('appointment-date')?.value;
            
            if (!timeSelect || !selectedDoctorId || !selectedDate) return;
            
            // SeÃ§ilen doktor ve tarihe ait rezerve edilmiÅŸ saatler
            const bookedTimes = allAppointments
                .filter(app => 
                    app.doctorId === selectedDoctorId && 
                    app.date === selectedDate && 
                    (app.status === 'confirmed' || app.status === 'pending')
                )
                .map(app => app.time);

            timeSelect.innerHTML = availableTimes.map(time => {
                const isBooked = bookedTimes.includes(time);
                return `
                    <option value="${time}" ${isBooked ? 'disabled' : ''} class="${isBooked ? 'text-gray-400' : 'text-green-600'}">
                        ${time} ${isBooked ? '(Dolu)' : '(MÃ¼sait)'}
                    </option>
                `;
            }).join('');
            
            // Ä°lk mÃ¼sait slotu seÃ§
            if (timeSelect.querySelector('option:not([disabled])')) {
                timeSelect.querySelector('option:not([disabled])').selected = true;
            }
        };
        
        const handleBooking = async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('booking-submit-btn');
            
            const selectedDoctorId = document.getElementById('appointment-doctor-id').value;
            const selectedDate = document.getElementById('appointment-date').value;
            const selectedTime = document.getElementById('appointment-time').value;
            const patientName = document.getElementById('patient-name').value;
            const patientPhone = document.getElementById('patient-phone').value;
            
            if (!selectedTime || document.getElementById('appointment-time').options[document.getElementById('appointment-time').selectedIndex]?.disabled) {
                showMessage('SeÃ§ilen saat dolu veya geÃ§ersiz. LÃ¼tfen baÅŸka bir saat seÃ§in.', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'Randevu OluÅŸturuluyor...';

            try {
                // 1. Hasta Bilgilerini Kaydet/GÃ¼ncelle
                const patientDocRef = doc(patientsColRef, userId);
                await setDoc(patientDocRef, {
                    uid: userId,
                    name: patientName,
                    phone: patientPhone,
                    updatedAt: serverTimestamp(),
                }, { merge: true });

                // 2. Randevuyu Kaydet
                const appointmentData = {
                    date: selectedDate,
                    time: selectedTime,
                    doctorId: selectedDoctorId,
                    doctorName: DOCTORS.find(d => d.id === selectedDoctorId)?.name || 'Bilinmeyen Doktor',
                    patientId: userId,
                    patientName: patientName,
                    patientPhone: patientPhone,
                    status: 'pending', 
                    serviceFee: DEFAULT_FEE, 
                    createdAt: serverTimestamp(),
                };

                await addDoc(appointmentsColRef, appointmentData);
                
                showMessage('Randevunuz baÅŸarÄ±yla oluÅŸturuldu ve doktor onayÄ± bekleniyor!', 'success');

            } catch (err) {
                console.error("Randevu kaydetme hatasÄ±:", err);
                showMessage('Randevu kaydedilirken bir hata oluÅŸtu: ' + err.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Randevuyu Onayla ve GÃ¶nder';
            }
        };

        const updatePatientAppointmentsList = () => {
            const listContainer = document.getElementById('patient-appointments-list');
            if (!listContainer) return;
            
            if (allAppointments.length === 0) {
                listContainer.innerHTML = '<p class="text-gray-500">HenÃ¼z randevunuz bulunmamaktadÄ±r. Hemen yukarÄ±dan randevu oluÅŸturabilirsiniz!</p>';
                return;
            }

            const html = allAppointments.map(app => {
                const statusColor = app.status === 'confirmed' ? 'bg-green-100 border-green-500' : 
                                     app.status === 'pending' ? 'bg-yellow-100 border-yellow-500' : 
                                     'bg-red-100 border-red-500';
                const statusTextClass = app.status === 'confirmed' ? 'text-green-800' : 
                                          app.status === 'pending' ? 'text-yellow-800' : 'text-red-800';

                return `
                    <div class="p-4 border rounded-xl shadow-md ${statusColor} border-l-4">
                        <p class="font-bold text-lg">${formatDate(app.date)} @ ${app.time}</p>
                        <p class="text-sm text-gray-600">Doktor: <span class="font-medium">${app.doctorName}</span></p>
                        <p class="text-sm text-gray-600">Ãœcret: <span class="font-bold text-secondary">${app.serviceFee || DEFAULT_FEE} TL</span></p>
                        <p class="text-sm text-gray-600">Durum: 
                            <span class="font-bold ml-1 px-2 py-1 rounded-full text-xs ${statusTextClass} bg-white/50">
                                ${app.status === 'confirmed' ? 'ONAYLANDI' : app.status === 'pending' ? 'ONAY BEKLÄ°YOR' : 'Ä°PTAL EDÄ°LDÄ°'}
                            </span>
                        </p>
                        
                        ${app.status === 'pending' ? `
                            <button data-id="${app.id}" class="cancel-appointment-btn mt-3 text-sm bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition">
                                Randevuyu Ä°ptal Et
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = `<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">${html}</div>`;
            
            document.querySelectorAll('.cancel-appointment-btn').forEach(btn => {
                btn.addEventListener('click', handleCancelAppointment);
            });
        };
        
        const handleCancelAppointment = async (e) => {
            const id = e.currentTarget.dataset.id;
            
            // window.confirm yerine Ã¶zel modal kullanÄ±lÄ±yor.
            renderConfirmationModal("Bu randevuyu iptal etmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.", async () => {
                try {
                    const docRef = doc(appointmentsColRef, id);
                    await setDoc(docRef, { status: 'cancelled' }, { merge: true });
                    showMessage("Randevunuz baÅŸarÄ±yla iptal edildi.", 'success');
                } catch (error) {
                    console.error("Ä°ptal hatasÄ±:", error);
                    showMessage("Randevu iptal edilirken bir hata oluÅŸtu: " + error.message, 'error');
                }
            });
        };

        // UygulamayÄ± baÅŸlat
        window.onload = initFirebase;

    </script>
</body>
</html>
