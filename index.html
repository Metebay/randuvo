<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="content="width=device-width, initial-scale=1.0">
    <title>Klinik Randevu Sistemi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome (Icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script>
        // Tailwind konfigürasyonu
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#10b981', // Emerald 500 (Hasta Rengi)
                        'secondary': '#f97316', // Orange 500
                        'accent': '#6366f1', // Indigo 500 (Doktor Rengi)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Inter fontunu Google Fonts'tan yükle */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Custom scrollbar */
        .scroll-area::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-area::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Slate 300 */
            border-radius: 4px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-gray-50 z-50">
        <div class="flex flex-col items-center p-6 bg-white rounded-xl shadow-lg">
            <div class="spinner !border-primary !border-t-gray-300 !w-8 !h-8 mb-4"></div>
            <p class="text-gray-600">Uygulama başlatılıyor...</p>
        </div>
    </div>
    
    <div id="app" class="flex flex-col min-h-screen">
        <!-- Ana İçerik Buraya Yüklenecek -->
    </div>

    <!-- Firebase SDK'ları -->
    <script type="module">
        import { 
            initializeApp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            query, 
            where, 
            addDoc, 
            deleteDoc,
            updateDoc,
            getDoc,
            serverTimestamp,
            setLogLevel,
            getDocs // YENİ: Dinamik randevu çakışması kontrolü için eklendi
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore log seviyesini ayarlama (Hata ayıklama için)
        setLogLevel('Debug');

        // --- Firebase Ortam Değişkenleri ve Sizin Yapılandırmanız ---

        const providedFirebaseConfig = {
            apiKey: "AIzaSyANE4jBU19fbVruV5NrtgPUvlfU4QCC0CA",
            authDomain: "randevutakip-7db24.firebaseapp.com",
            projectId: "randevutakip-7db24",
            storageBucket: "randevutakip-7db24.firebase-storage.app",
            messagingSenderId: "738418873977",
            appId: "1:738418873977:web:d0a5b8dbfe74777949e6a8",
            measurementId: "G-2LEEET92VJ"
        };
        
        // Canvas ortam değişkenlerini tercih et, yoksa sağlanan config'i kullan
        const appId = typeof __app_id !== 'undefined' ? __app_id : providedFirebaseConfig.projectId;
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : providedFirebaseConfig;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let userRole = null;
        let userProfile = null;
        let appointments = []; // Doktor randevuları
        let patientAppointments = []; // Hasta randevuları
        let patients = []; // Tüm hastalar (Doktor paneli için)
        let doctors = []; // Tüm doktorlar (Hasta paneli için)
        
        // YENİ: Doktor çalışma saatleri
        let doctorAvailability = null; 
        
        // YENİ: Günlük istatistikler
        let todayExaminedCount = 0;
        let todayTotalAppointments = 0;


        // --- Firebase Yollarını ve Veri Fonksiyonlarını Yönetme ---

        // Ortak (public) koleksiyon yolu, güvenlik kurallarına uygun
        const getCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        const userCollectionRef = () => collection(db, getCollectionPath('users'));
        const appointmentCollectionRef = () => collection(db, getCollectionPath('appointments'));
        
        // Doktor müsaitlik koleksiyon yolu
        const doctorAvailabilityCollectionRef = () => collection(db, getCollectionPath('doctorAvailability'));


        // --- Başlatma ve Kimlik Doğrulama ---

        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase yapılandırması bulunamadı.");
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Özel kimlik doğrulama tokeni ile giriş yapıldı.");
                } else {
                    console.warn("Özel kimlik doğrulama tokeni bulunamadı. Anonim giriş denemesi atlandı. Kullanıcı girişi gerekecek.");
                }

                onAuthStateChanged(auth, async (user) => {
                    userId = user ? user.uid : null;
                    userRole = null;
                    userProfile = null;

                    if (userId) {
                        await fetchUserProfile(userId);
                    } else {
                        userRole = 'anonymous'; 
                    }
                    
                    document.getElementById('loading-screen').classList.add('hidden');
                    renderApp();
                });
            } catch (error) {
                console.error("Firebase başlatılırken hata oluştu:", error);
                document.getElementById('loading-screen').innerHTML = `
                    <div class="text-center p-6 bg-white rounded-xl shadow-lg">
                        <p class="text-red-600 font-bold">Uygulama Hatası</p>
                        <p class="text-gray-500 mt-2">Firebase'i başlatırken sorun oluştu: ${error.message}</p>
                        <p class="text-xs text-gray-400 mt-2">Lütfen kimlik doğrulama ayarlarınızı kontrol edin.</p>
                    </div>
                `;
            }
        };

        const fetchUserProfile = async (uid) => {
            if (!uid) return;
            try {
                const userDocRef = doc(db, getCollectionPath('users'), uid);
                const userSnapshot = await getDoc(userDocRef);
                
                if (userSnapshot.exists()) {
                    userProfile = { uid, ...userSnapshot.data() };
                    userRole = userProfile.role;
                } else {
                    userRole = 'anonymous'; 
                }
            } catch (error) {
                console.error("Kullanıcı profili çekilirken hata:", error);
                userRole = 'anonymous';
            }
        };

        // --- Randevu ve Doktor Dinleyicileri ---

        const setupAppointmentListener = () => {
            if (userRole !== 'doctor' || !userId) {
                appointments = [];
                todayExaminedCount = 0;
                todayTotalAppointments = 0;
                return;
            }

            const q = query(appointmentCollectionRef(), where("doctorId", "==", userId));
            onSnapshot(q, (snapshot) => {
                appointments = snapshot.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(), 
                    // Firestore Timestamp'ı JS Date objesine çevir
                    datetime: d.data().datetime.toDate() 
                }));
                appointments.sort((a, b) => b.datetime.getTime() - a.datetime.getTime()); 
                
                // Bugünün randevularını say
                const now = new Date();
                // Tarihi 'YYYY-MM-DD' formatında al
                const today = now.toLocaleDateString('en-CA'); 
                
                const todayAppointments = appointments.filter(app => {
                    // Randevu tarihini 'YYYY-MM-DD' formatında al
                    const appDate = app.datetime.toLocaleDateString('en-CA');
                    return appDate === today;
                });
                
                todayTotalAppointments = todayAppointments.length;
                
                // Muayene edilmiş sayısını bul (procedure alanı dolu olanlar)
                todayExaminedCount = todayAppointments.filter(app => 
                    app.procedure && app.procedure.length > 0
                ).length;

                renderDoctorPanel();
            }, (error) => {
                console.error("Doktor randevularını dinlerken hata:", error);
                showNotification("Randevuları çekerken bir sorun oluştu.", "error");
            });

            // Tüm hastaları çek (randevu oluşturma formu için)
            const patientsQ = query(userCollectionRef(), where("role", "==", "patient"));
            onSnapshot(patientsQ, (snapshot) => {
                patients = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
                if (currentView === 'doctor-panel') renderDoctorPanel();
            });
        };
        
        // Doktorun çalışma saatlerini dinleyen fonksiyon
        const setupDoctorAvailabilityListener = () => {
            if (userRole !== 'doctor' || !userId) {
                doctorAvailability = null;
                return;
            }

            // Doktorun kendi ID'sine özel dökümanı dinle
            const docRef = doc(db, getCollectionPath('doctorAvailability'), userId);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    doctorAvailability = docSnap.data();
                } else {
                    doctorAvailability = null; // Hiç ayar yapılmamışsa null
                }
                // Sadece panel açıksa tekrar çiz
                if (currentView === 'doctor-panel') renderDoctorPanel();
            }, (error) => {
                console.error("Çalışma saatlerini dinlerken hata:", error);
                showNotification("Çalışma saatlerini çekerken bir sorun oluştu.", "error");
            });
        };

        const setupPatientAppointmentListener = () => {
            if (userRole !== 'patient' || !userId) {
                 patientAppointments = [];
                 return;
            }
            const q = query(appointmentCollectionRef(), where("patientId", "==", userId));
            onSnapshot(q, (snapshot) => {
                patientAppointments = snapshot.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(), 
                    datetime: d.data().datetime.toDate() 
                }));
                patientAppointments.sort((a, b) => b.datetime.getTime() - a.datetime.getTime()); 
                renderPatientPanel();
            }, (error) => {
                console.error("Hasta randevularını dinlerken hata:", error);
                showNotification("Randevularınızı çekerken bir sorun oluştu.", "error");
            });
        };
        
        const setupDoctorListener = () => {
            if (userRole !== 'patient') {
                doctors = [];
                return;
            }

            const doctorQ = query(userCollectionRef(), where("role", "==", "doctor"));
            onSnapshot(doctorQ, (snapshot) => {
                doctors = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
                if (currentView === 'patient-panel') renderPatientPanel(); 
            }, (error) => {
                console.error("Doktor listesini dinlerken hata:", error);
            });
        };


        // --- Router ve Görünüm Yönetimi ---

        let currentView = 'home';

        window.navigate = (view) => {
            currentView = view;
            renderApp();
        };

        const renderApp = () => {
            const appElement = document.getElementById('app');
            appElement.innerHTML = '';
            
            const headerHtml = renderHeader();
            appElement.insertAdjacentHTML('afterbegin', headerHtml);

            if (userRole === 'doctor') {
                if (currentView !== 'doctor-panel') {
                     currentView = 'doctor-panel';
                     setupAppointmentListener(); // Randevular ve günlük sayım için
                     setupDoctorAvailabilityListener(); // Çalışma saatleri için
                }
                renderDoctorPanel(appElement);
            } else if (userRole === 'patient') {
                if (currentView !== 'patient-panel') {
                    currentView = 'patient-panel';
                    setupPatientAppointmentListener();
                    setupDoctorListener();
                }
                renderPatientPanel(appElement);
            } else if (currentView === 'doctor-login') {
                 renderDoctorLogin(appElement);
            } else if (currentView === 'patient-register') {
                 renderPatientRegister(appElement);
            } else if (currentView === 'patient-login') {
                 renderPatientLogin(appElement);
            } else {
                renderHome(appElement);
            }
        };

        // --- UI Bileşenleri ---
        
        // Doktor Çalışma Saatleri Yönetim Formu
        const renderAvailabilityManager = () => {
            const startHour = doctorAvailability?.startTime || '09:00';
            const endHour = doctorAvailability?.endTime || '17:00';
            
            let statusText = doctorAvailability ? 
                `<span class="text-green-600 font-semibold">${startHour} - ${endHour}</span> arası müsait.` : 
                '<span class="text-red-600 font-semibold">Çalışma saati ayarlanmamış.</span>';

            return `
                <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                         <i class="fas fa-clock mr-2 text-accent"></i> Çalışma Saatleri Yönetimi
                    </h3>
                    <p class="mb-4 text-gray-600">Mevcut Durum: ${statusText}</p>
                    
                    <form id="availability-form" class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="col-span-1">
                            <label for="start-time" class="block text-sm font-medium text-gray-700 mb-1">Başlangıç Saati</label>
                            <input type="time" id="start-time" required value="${startHour}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                        </div>
                        <div class="col-span-1">
                            <label for="end-time" class="block text-sm font-medium text-gray-700 mb-1">Bitiş Saati</label>
                            <input type="time" id="end-time" required value="${endHour}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                        </div>
                        <div class="col-span-2 md:col-span-2 text-right">
                            <button type="submit" id="set-availability-btn" class="w-full md:w-auto px-6 py-2 bg-accent hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                                Saatleri Kaydet
                            </button>
                        </div>
                    </form>
                </div>
            `;
        };


        const renderHeader = () => {
            const isLoggedIn = userRole !== 'anonymous' && userRole !== null && userId !== null;
            const roleText = userRole === 'doctor' ? 'Doktor' : (userRole === 'patient' ? 'Hasta' : '');
            
            let navItems = '';
            if (isLoggedIn) {
                const name = userProfile?.name || '';
                const surname = userProfile?.surname || '';
                const displayId = userId ? `${userId.substring(0, 4)}...${userId.substring(userId.length - 4)}` : '';

                navItems = `
                    <div class="hidden lg:block text-white text-sm mr-4 text-right">
                        <span class="font-bold">${name} ${surname}</span> (${roleText})<br>
                        <span class="text-xs text-gray-400">UID: ${displayId}</span>
                    </div>
                    <button id="logout-btn" class="ml-2 px-4 py-1.5 bg-secondary hover:bg-orange-600 text-white text-sm font-semibold rounded-lg shadow-md transition-colors duration-200">
                        <i class="fas fa-sign-out-alt mr-1"></i> Çıkış Yap
                    </button>
                `;
            } else {
                navItems = `
                    <button onclick="navigate('doctor-login')" class="px-3 py-1.5 bg-accent hover:bg-indigo-600 text-white text-sm font-semibold rounded-lg shadow-md transition-colors duration-200 mr-2">
                        Doktor Girişi
                    </button>
                    <button onclick="navigate('patient-login')" class="px-3 py-1.5 bg-primary hover:bg-emerald-600 text-white text-sm font-semibold rounded-lg shadow-md transition-colors duration-200">
                        Hasta Girişi
                    </button>
                `;
            }

            return `
                <header class="bg-gray-800 shadow-xl sticky top-0 z-10">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                        <h1 class="text-xl font-bold text-white cursor-pointer" onclick="navigate('home')">
                            <i class="fas fa-clinic-medical mr-2 text-primary"></i> KLİNİK YÖNETİM
                        </h1>
                        <nav class="flex items-center">
                            ${navItems}
                        </nav>
                    </div>
                </header>
            `;
        };

        const renderDoctorPanel = (appElement) => {
            if (userRole !== 'doctor') return;

            const appointmentsHtml = appointments.length === 0 ? 
                '<p class="text-center text-gray-500 mt-8">Bugüne veya geleceğe ait randevu bulunmamaktadır.</p>' :
                appointments.map(renderAppointmentCard).join('');

            const html = `
                <main class="flex-grow p-4 sm:p-8">
                    <div class="max-w-7xl mx-auto">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-8">
                            <i class="fas fa-stethoscope mr-3 text-accent"></i> Doktor Paneli (${userProfile.name} ${userProfile.surname})
                        </h2>
                        <div id="notification-container" class="mb-6"></div>

                        <!-- İstatistikler ve Çalışma Saatleri Bölümü -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                            <!-- Günlük İstatistikler Kartı -->
                            <div class="bg-white p-6 rounded-2xl shadow-xl border-t-4 border-primary">
                                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-chart-line mr-2 text-primary"></i> Günlük İstatistikler
                                </h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center text-gray-600">
                                        <span>Bugünkü Toplam Randevu:</span>
                                        <span class="text-2xl font-bold text-primary">${todayTotalAppointments}</span>
                                    </div>
                                    <div class="flex justify-between items-center text-gray-600 border-t pt-3">
                                        <span>Bugün Muayene Edilen:</span>
                                        <span class="text-2xl font-bold text-accent">${todayExaminedCount}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Çalışma Saatleri Yönetimi Kartı (2/3 alanı kaplayacak şekilde) -->
                            <div class="lg:col-span-2">
                                ${renderAvailabilityManager()}
                            </div>
                        </div>


                        <!-- Randevu Oluşturma ve Filtreleme -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-8">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                                Randevu Oluşturma
                                <button onclick="toggleNewAppointmentForm()" class="px-4 py-2 bg-primary hover:bg-emerald-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                                    <i class="fas fa-calendar-plus mr-2"></i> Yeni Randevu Oluştur
                                </button>
                            </h3>
                            <!-- Yeni Randevu Formu (Toggleable) -->
                            <div id="new-appointment-form-container" class="hidden mt-4 pt-4 border-t border-gray-200">
                                ${renderNewAppointmentForm()}
                            </div>
                        </div>

                        <!-- Randevu Listesi -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-list-ul mr-2 text-primary"></i> Randevu Listesi (Gelecekten Geçmişe)
                            </h3>
                            <div id="appointment-list" class="scroll-area space-y-4 max-h-[70vh] overflow-y-auto">
                                ${appointmentsHtml}
                            </div>
                        </div>
                    </div>
                    <!-- Modal Placeholder -->
                    <div id="modal-container"></div>
                </main>
            `;
            appElement.innerHTML += html;
            
            // Event listener'ları yeniden bağla
            document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', handleDeleteClick));
            document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', handleEditClick));
            
            // Çalışma saatleri formunu bağla
            document.getElementById('availability-form')?.addEventListener('submit', handleSetAvailability);
        };
        
        const renderPatientPanel = (appElement) => {
            if (userRole !== 'patient') return;

            const patientAppointmentsHtml = patientAppointments.length === 0 ? 
                '<p class="text-center text-gray-500 mt-8">Henüz kayıtlı veya geçmiş randevunuz bulunmamaktadır.</p>' :
                patientAppointments.map(renderPatientAppointmentCard).join('');

             const html = `
                <main class="flex-grow p-4 sm:p-8">
                    <div class="max-w-6xl mx-auto">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-8">
                            <i class="fas fa-user-circle mr-3 text-primary"></i> Hasta Paneli
                        </h2>
                        <div id="notification-container" class="mb-6"></div>

                        <!-- 1. Randevu Alma Bölümü -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl mb-8 border-t-4 border-accent">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                                <i class="fas fa-calendar-alt mr-2 text-accent"></i> Yeni Randevu Al
                                <button onclick="togglePatientNewAppointmentForm()" class="px-4 py-2 bg-accent hover:bg-indigo-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                                    Randevu Formunu ${document.getElementById('patient-new-appointment-form-container')?.classList.contains('hidden') ? 'Aç' : 'Kapat'}
                                </button>
                            </h3>
                            <div id="patient-new-appointment-form-container" class="mt-4 pt-4 border-t border-gray-200 ${currentView === 'patient-panel' ? (document.getElementById('patient-new-appointment-form-container') && !document.getElementById('patient-new-appointment-form-container').classList.contains('hidden') ? '' : 'hidden') : 'hidden'}">
                                ${renderNewPatientAppointmentForm()}
                            </div>
                        </div>

                        <!-- 2. Randevu Geçmişi ve Gelecek Randevular -->
                        <div class="bg-white p-6 rounded-2xl shadow-xl">
                            <h3 class="text-2xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-history mr-2 text-primary"></i> Randevu Geçmişi ve Gelecek Randevular (En Yeni Üstte)
                            </h3>
                            <div class="scroll-area space-y-4 max-h-[60vh] overflow-y-auto">
                                ${patientAppointmentsHtml}
                            </div>
                        </div>
                        
                         <!-- Kullanıcı Bilgileri -->
                         <div class="mt-8 p-4 bg-gray-100 rounded-xl shadow-inner border border-gray-200 text-sm text-gray-600">
                             <p><span class="font-semibold">Ad Soyad:</span> ${userProfile.name} ${userProfile.surname}</p>
                             <p><span class="font-semibold">E-posta:</span> ${userProfile.email}</p>
                             <p class="text-xs mt-1"><span class="font-semibold">Kullanıcı Kimliği:</span> ${userId}</p>
                         </div>
                    </div>
                </main>
            `;
            appElement.innerHTML += html;
            
            const formContainer = document.getElementById('patient-new-appointment-form-container');
            if(formContainer && !formContainer.classList.contains('hidden')) {
                const doctorSelect = document.getElementById('p-new-doctor-id');
                const dateInput = document.getElementById('p-new-date');
                const timeSelect = document.getElementById('p-new-time');

                // Formun submit olayını bağla
                document.getElementById('patient-new-appointment-form').addEventListener('submit', handlePatientNewAppointment);
                
                // YENİ: Doktor veya tarih değiştiğinde slotları güncelle
                if (doctorSelect && dateInput) {
                    doctorSelect.addEventListener('change', updateTimeSlots);
                    dateInput.addEventListener('change', updateTimeSlots);
                    
                    // Form açıldığında slotları otomatik olarak yükle (eğer bir doktor seçiliyse)
                    if(doctorSelect.value) {
                       updateTimeSlots();
                    }
                }
            }
        };

        // --- Eksik Temel UI Fonksiyonları (Hata Düzeltmeleri) ---

        const renderHome = (appElement) => {
            const html = `
                <main class="flex-grow flex items-center justify-center p-4 sm:p-8">
                    <div class="max-w-xl text-center bg-white p-10 rounded-3xl shadow-2xl">
                        <i class="fas fa-laptop-medical text-6xl text-primary mb-4"></i>
                        <h2 class="text-3xl font-extrabold text-gray-900 mb-4">
                            Klinik Randevu ve Yönetim Sistemi
                        </h2>
                        <p class="text-lg text-gray-600 mb-8">
                            Lütfen rolünüze uygun olarak giriş yapın.
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                            <button onclick="navigate('doctor-login')" class="px-8 py-3 bg-accent hover:bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition-transform transform hover:scale-[1.02]">
                                <i class="fas fa-stethoscope mr-2"></i> Doktor Girişi
                            </button>
                            <button onclick="navigate('patient-login')" class="px-8 py-3 bg-primary hover:bg-emerald-600 text-white font-bold rounded-xl shadow-lg transition-transform transform hover:scale-[1.02]">
                                <i class="fas fa-user-injured mr-2"></i> Hasta Girişi
                            </button>
                        </div>
                    </div>
                </main>
            `;
            appElement.innerHTML += html;
        };

        const renderAuthForm = (title, formHtml, appElement) => {
            const html = `
                <main class="flex-grow flex items-center justify-center p-4 sm:p-8">
                    <div class="w-full max-w-md bg-white p-8 rounded-2xl shadow-2xl border-t-4 border-accent">
                        <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">${title}</h2>
                        <div id="notification-container" class="mb-4"></div>
                        ${formHtml}
                    </div>
                </main>
            `;
            appElement.innerHTML += html;
        };

        const renderDoctorLogin = (appElement) => {
            const formHtml = `
                <form id="doctor-login-form" onsubmit="handleDoctorLogin(event)" class="space-y-4">
                    <div>
                        <label for="d-email" class="block text-sm font-medium text-gray-700">E-posta</label>
                        <input type="email" id="d-email" required placeholder="doktor@klinik.com" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                    </div>
                    <div>
                        <label for="d-password" class="block text-sm font-medium text-gray-700">Şifre</label>
                        <input type="password" id="d-password" required placeholder="********" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                    </div>
                    <button type="submit" id="d-login-btn" class="w-full px-4 py-2 bg-accent hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i> Giriş Yap (Doktor)
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">Henüz kaydınız yok mu? Bir <span class="font-bold text-red-500">doktor hesabı</span> oluşturmak için lütfen yöneticinizle iletişime geçin.</p>
                    </div>
                </form>
            `;
            renderAuthForm('<i class="fas fa-user-md mr-2 text-accent"></i> Doktor Girişi', formHtml, appElement);
        };

        const renderPatientLogin = (appElement) => {
            const formHtml = `
                <form id="patient-login-form" onsubmit="handlePatientLogin(event)" class="space-y-4">
                    <div>
                        <label for="p-email" class="block text-sm font-medium text-gray-700">E-posta</label>
                        <input type="email" id="p-email" required placeholder="hasta@ornek.com" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="p-password" class="block text-sm font-medium text-gray-700">Şifre</label>
                        <input type="password" id="p-password" required placeholder="********" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <button type="submit" id="p-login-btn" class="w-full px-4 py-2 bg-primary hover:bg-emerald-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                        <i class="fas fa-sign-in-alt mr-2"></i> Giriş Yap (Hasta)
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">Hesabınız yok mu? <a href="#" onclick="navigate('patient-register')" class="text-primary font-semibold hover:underline">Şimdi Kaydolun</a></p>
                    </div>
                </form>
            `;
            renderAuthForm('<i class="fas fa-user-injured mr-2 text-primary"></i> Hasta Girişi', formHtml, appElement);
        };
        
        const renderPatientRegister = (appElement) => {
            const formHtml = `
                <form id="patient-register-form" onsubmit="handlePatientRegistration(event)" class="space-y-4">
                    <div>
                        <label for="r-name" class="block text-sm font-medium text-gray-700">Ad</label>
                        <input type="text" id="r-name" required placeholder="Adınız" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="r-surname" class="block text-sm font-medium text-gray-700">Soyad</label>
                        <input type="text" id="r-surname" required placeholder="Soyadınız" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="r-email" class="block text-sm font-medium text-gray-700">E-posta</label>
                        <input type="email" id="r-email" required placeholder="e-posta@adresiniz.com" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="r-password" class="block text-sm font-medium text-gray-700">Şifre</label>
                        <input type="password" id="r-password" required placeholder="En az 6 karakter" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <button type="submit" id="r-register-btn" class="w-full px-4 py-2 bg-primary hover:bg-emerald-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                        <i class="fas fa-user-plus mr-2"></i> Kaydol
                    </button>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">Zaten hesabınız var mı? <a href="#" onclick="navigate('patient-login')" class="text-primary font-semibold hover:underline">Giriş Yapın</a></p>
                    </div>
                </form>
            `;
            renderAuthForm('<i class="fas fa-user-plus mr-2 text-primary"></i> Hasta Kayıt', formHtml, appElement);
        };


        // --- Kimlik Doğrulama İşleyicileri ---

        const handleDoctorLogin = async (e) => {
            e.preventDefault();
            const email = e.target.elements['d-email'].value;
            const password = e.target.elements['d-password'].value;
            const btn = document.getElementById('d-login-btn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<div class="spinner !border-t-white"></div> Giriş Yapılıyor...';
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Profil verisini çek ve rolü kontrol et
                const userDocRef = doc(db, getCollectionPath('users'), userCredential.user.uid);
                const userSnapshot = await getDoc(userDocRef);

                if (!userSnapshot.exists() || userSnapshot.data().role !== 'doctor') {
                    await signOut(auth); // Rolü doktor değilse çıkış yap
                    showNotification("Bu hesap bir doktor hesabı değildir.", "error");
                    navigate('doctor-login');
                    return;
                }
                
                showNotification("Doktor girişi başarılı!", "success");
                // onAuthStateChanged tetiklenecek ve paneli render edecek
            } catch (error) {
                console.error("Doktor girişi başarısız:", error);
                const errorMessage = error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' ? 
                    "E-posta veya şifre hatalı." : "Giriş yapılırken bir sorun oluştu.";
                showNotification(errorMessage, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        const handlePatientLogin = async (e) => {
            e.preventDefault();
            const email = e.target.elements['p-email'].value;
            const password = e.target.elements['p-password'].value;
            const btn = document.getElementById('p-login-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<div class="spinner !border-t-white"></div> Giriş Yapılıyor...';
            btn.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);

                // Profil verisini çek ve rolü kontrol et
                const userDocRef = doc(db, getCollectionPath('users'), userCredential.user.uid);
                const userSnapshot = await getDoc(userDocRef);

                if (!userSnapshot.exists() || userSnapshot.data().role !== 'patient') {
                    await signOut(auth); // Rolü hasta değilse çıkış yap
                    showNotification("Bu hesap bir hasta hesabı değildir.", "error");
                    navigate('patient-login');
                    return;
                }
                
                showNotification("Hasta girişi başarılı!", "success");
                // onAuthStateChanged tetiklenecek ve paneli render edecek
            } catch (error) {
                console.error("Hasta girişi başarısız:", error);
                const errorMessage = error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' ? 
                    "E-posta veya şifre hatalı." : "Giriş yapılırken bir sorun oluştu.";
                showNotification(errorMessage, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        const handlePatientRegistration = async (e) => {
            e.preventDefault();
            const name = e.target.elements['r-name'].value.trim();
            const surname = e.target.elements['r-surname'].value.trim();
            const email = e.target.elements['r-email'].value.trim();
            const password = e.target.elements['r-password'].value;
            const btn = document.getElementById('r-register-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<div class="spinner !border-t-white"></div> Kayıt Olunuyor...';
            btn.disabled = true;

            try {
                if (password.length < 6) {
                    showNotification("Şifre en az 6 karakter olmalıdır.", "error");
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Firestore'a kullanıcı profilini kaydet
                await setDoc(doc(db, getCollectionPath('users'), userCredential.user.uid), {
                    name,
                    surname,
                    email,
                    role: 'patient', 
                    createdAt: serverTimestamp(),
                });

                showNotification("Kayıt başarılı! Giriş yapılıyor...", "success");
                // onAuthStateChanged tetiklenecek ve paneli render edecek
            } catch (error) {
                console.error("Kayıt başarısız:", error);
                const errorMessage = error.code === 'auth/email-already-in-use' ? 
                    "Bu e-posta adresi zaten kullanılıyor." : "Kayıt sırasında bir hata oluştu.";
                showNotification(errorMessage, "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.handleDoctorLogin = handleDoctorLogin;
        window.handlePatientLogin = handlePatientLogin;
        window.handlePatientRegistration = handlePatientRegistration;


        // --- Randevu İşlemleri İşleyicileri ---
        
        const handleSetAvailability = async (e) => {
            e.preventDefault();
            const form = e.target;
            const startTime = form.elements['start-time'].value;
            const endTime = form.elements['end-time'].value;

            if (!startTime || !endTime) {
                showNotification("Lütfen hem başlangıç hem de bitiş saatini girin.", "error");
                return;
            }
            
            // Basit saat kontrolü (Sadece string karşılaştırması yeterli)
            if (startTime >= endTime) {
                 showNotification("Bitiş saati, başlangıç saatinden sonra olmalıdır.", "error");
                 return;
            }

            try {
                const docRef = doc(db, getCollectionPath('doctorAvailability'), userId);
                await setDoc(docRef, {
                    doctorId: userId,
                    startTime: startTime, // Örn: "09:00"
                    endTime: endTime,   // Örn: "17:00"
                    updatedAt: serverTimestamp(),
                }, { merge: true });

                showNotification(`Çalışma saatleri başarıyla kaydedildi: ${startTime} - ${endTime}`, "success");

            } catch (error) {
                console.error("Çalışma saati kaydetme hatası:", error);
                showNotification(`Saatler kaydedilirken hata: ${error.message}.`, "error");
            }
        };

        const renderNewAppointmentForm = () => {
             const patientOptions = patients.map(p => 
                `<option value="${p.uid}" data-name="${p.name} ${p.surname}">${p.name} ${p.surname} (E-posta: ${p.email})</option>`
            ).join('');

            const today = new Date().toISOString().slice(0, 10);
            const now = new Date();
            const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            
            return `
                <form id="new-appointment-form" class="grid grid-cols-1 md:grid-cols-3 gap-4" onsubmit="handleNewAppointment(event)">
                    <div class="md:col-span-1">
                        <label for="new-patient-id" class="block text-sm font-medium text-gray-700 mb-1">Hasta Seçin</label>
                        <select id="new-patient-id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                            <option value="" disabled selected>--- Kayıtlı Hasta Seçiniz ---</option>
                            ${patientOptions}
                        </select>
                    </div>
                    <div>
                        <label for="new-date" class="block text-sm font-medium text-gray-700 mb-1">Tarih</label>
                        <input type="date" id="new-date" required min="${today}" value="${today}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div>
                        <label for="new-time" class="block text-sm font-medium text-gray-700 mb-1">Saat</label>
                        <input type="time" id="new-time" required value="${timeString}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">
                    </div>
                    <div class="md:col-span-3">
                        <label for="new-notes" class="block text-sm font-medium text-gray-700 mb-1">Kısa Açıklama/Notlar</label>
                        <textarea id="new-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary" placeholder="Randevu nedeni veya notlar..."></textarea>
                    </div>
                    <div class="md:col-span-3 text-right">
                        <button type="submit" id="new-appointment-btn" class="px-6 py-2 bg-primary hover:bg-emerald-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                            Randevuyu Kaydet
                        </button>
                    </div>
                </form>
            `;
        };

        const renderAppointmentCard = (app) => {
            const patient = patients.find(p => p.uid === app.patientId);
            const patientName = patient ? `${patient.name} ${patient.surname}` : 'Bilinmiyor';
            const dateStr = app.datetime.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
            const timeStr = app.datetime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            
            let statusBadge = '';
            let feeStatus = '';
            if (app.procedure && app.procedure.length > 0) {
                 statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Tamamlandı</span>';
            } else {
                 statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-medium rounded-full">Planlandı</span>';
            }

            if (app.fee > 0) {
                 feeStatus = `<span class="text-sm font-semibold text-green-600">${app.fee} TL</span>`;
            } else {
                 feeStatus = '<span class="text-sm font-semibold text-red-600">Ücret Girilmedi</span>';
            }


            return `
                <div class="bg-gray-50 border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow duration-200 flex flex-col md:flex-row justify-between">
                    <div class="flex-grow">
                        <div class="flex items-center space-x-2 mb-2">
                            <p class="text-lg font-bold text-gray-800">
                                <i class="fas fa-user-injured mr-2 text-accent"></i> ${patientName}
                            </p>
                             ${statusBadge}
                        </div>
                        <p class="text-sm text-gray-600 mb-1">
                            <i class="fas fa-calendar-alt mr-2 text-primary"></i> ${dateStr} - ${timeStr}
                        </p>
                        <p class="text-sm text-gray-500 italic mb-2">
                            <i class="fas fa-sticky-note mr-2 text-gray-400"></i> ${app.notes || 'Açıklama yok'}
                        </p>
                        <div class="mt-2 text-sm">
                            <span class="font-medium text-gray-700">Ücret:</span> ${feeStatus}
                        </div>
                    </div>
                    <div class="flex flex-col space-y-2 mt-3 md:mt-0 md:ml-4 justify-start min-w-[150px]">
                        <button data-id="${app.id}" class="edit-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-lg transition-colors duration-200">
                            <i class="fas fa-edit"></i> İşlem/Ücret Ekle
                        </button>
                        <button data-id="${app.id}" class="delete-btn px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-semibold rounded-lg transition-colors duration-200">
                            <i class="fas fa-trash-alt"></i> Sil
                        </button>
                    </div>
                </div>
            `;
        };
        
        const renderPatientAppointmentCard = (app) => {
            const dateStr = app.datetime.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' });
            const timeStr = app.datetime.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            
            const isPast = app.datetime.getTime() < new Date().getTime();
            
            let statusBadge = '';
            let details = '';
            let cardColor = 'border-gray-300';

            if (app.procedure && app.procedure.length > 0) {
                 statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-800 text-sm font-medium rounded-full"><i class="fas fa-check-circle mr-1"></i> Tamamlandı</span>';
                 details = `<p class="text-sm text-gray-700 mt-2"><span class="font-semibold text-accent">Yapılan İşlem:</span> ${app.procedure}</p>
                            <p class="text-sm text-gray-700"><span class="font-semibold text-accent">Ücret:</span> ${app.fee} TL</p>`;
                 cardColor = 'border-green-500';
            } else if (isPast) {
                 statusBadge = '<span class="px-3 py-1 bg-red-100 text-red-800 text-sm font-medium rounded-full"><i class="fas fa-times-circle mr-1"></i> Geçmiş (İşlem Yok)</span>';
                 cardColor = 'border-red-500';
            } else {
                 statusBadge = '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm font-medium rounded-full"><i class="fas fa-hourglass-half mr-1"></i> Planlandı</span>';
                 cardColor = 'border-yellow-500';
            }

            return `
                <div class="bg-white p-5 rounded-xl shadow-lg border-l-4 ${cardColor} flex flex-col">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-grow">
                            <p class="text-xl font-bold text-gray-900">
                                <i class="fas fa-user-md mr-2 text-accent"></i> Dr. ${app.doctorName}
                            </p>
                        </div>
                        <div class="ml-4 flex-shrink-0">
                            ${statusBadge}
                        </div>
                    </div>
                    
                    <p class="text-base text-gray-600">
                        <i class="fas fa-calendar-alt mr-2 text-primary"></i> ${dateStr} | 
                        <i class="fas fa-clock mr-2 text-primary"></i> ${timeStr}
                    </p>
                    
                    <p class="text-sm text-gray-500 italic mt-3 border-t pt-2">
                        <span class="font-medium text-gray-700">Not:</span> ${app.notes || 'Randevu notu yok.'}
                    </p>
                    
                    ${details}
                </div>
            `;
        };
        
        const renderNewPatientAppointmentForm = () => {
             const doctorOptions = doctors.map(d => 
                `<option value="${d.uid}" data-name="${d.name} ${d.surname}">${d.name} ${d.surname} (${d.email})</option>`
            ).join('');

            const today = new Date().toISOString().slice(0, 10);
            
            // YENİ: Zaman seçenekleri artık dinamik olarak yüklenecektir
            const timeHtml = `
                <select id="p-new-time" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent" disabled>
                    <option value="" disabled selected>Önce Doktor ve Tarih Seçiniz</option>
                </select>
                <div id="slot-status" class="mt-2 h-5"></div>
            `;
            
            return `
                <form id="patient-new-appointment-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-5 bg-indigo-50 rounded-xl border border-indigo-200">
                    <div class="md:col-span-1">
                        <label for="p-new-doctor-id" class="block text-sm font-medium text-gray-700 mb-1">Doktor Seçin</label>
                        <select id="p-new-doctor-id" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                            <option value="" disabled selected>--- Uzmanlık Alanı Seçiniz ---</option>
                            ${doctorOptions}
                        </select>
                        ${doctors.length === 0 ? '<p class="text-xs text-red-500 mt-1">Sistemde kayıtlı doktor bulunamadı!</p>' : ''}
                    </div>
                    <div>
                        <label for="p-new-date" class="block text-sm font-medium text-gray-700 mb-1">Randevu Tarihi</label>
                        <input type="date" id="p-new-date" required min="${today}" value="${today}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent">
                    </div>
                    <div>
                        <label for="p-new-time" class="block text-sm font-medium text-gray-700 mb-1">Randevu Saati (Müsait Slotlar)</label>
                        ${timeHtml}
                    </div>
                    <div class="md:col-span-3">
                        <label for="p-new-notes" class="block text-sm font-medium text-gray-700 mb-1">Randevu Nedeni/Notlar</label>
                        <textarea id="p-new-notes" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-accent focus:border-accent" placeholder="Kısa bir açıklama girin..."></textarea>
                    </div>
                    <div class="md:col-span-3 text-right">
                        <button type="submit" id="p-new-appointment-btn" class="px-6 py-2 bg-accent hover:bg-indigo-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                            <i class="fas fa-calendar-check mr-2"></i> Randevu Al
                        </button>
                    </div>
                </form>
            `;
        };

        window.toggleNewAppointmentForm = () => {
            const container = document.getElementById('new-appointment-form-container');
            const form = document.getElementById('new-appointment-form');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        };
        
        window.togglePatientNewAppointmentForm = () => {
            const container = document.getElementById('patient-new-appointment-form-container');
            
            if (container.classList.contains('hidden')) {
                container.innerHTML = renderNewPatientAppointmentForm(); 
                container.classList.remove('hidden');
                
                // Form yüklendikten sonra event listener'ları bağla
                const doctorSelect = document.getElementById('p-new-doctor-id');
                const dateInput = document.getElementById('p-new-date');
                
                document.getElementById('patient-new-appointment-form').addEventListener('submit', handlePatientNewAppointment);
                
                if (doctorSelect && dateInput) {
                    doctorSelect.addEventListener('change', updateTimeSlots);
                    dateInput.addEventListener('change', updateTimeSlots);
                    
                    // Başlangıçta slotları yüklemeyi dene
                    if(doctorSelect.value) {
                       updateTimeSlots();
                    }
                }
                
            } else {
                container.classList.add('hidden');
            }
            renderApp();
        };

        const handleNewAppointment = async (e) => {
            e.preventDefault();
            const form = e.target;
            const patientId = form.elements['new-patient-id'].value;
            const dateStr = form.elements['new-date'].value;
            const timeStr = form.elements['new-time'].value;
            const notes = form.elements['new-notes'].value.trim();
            
            const datetime = new Date(`${dateStr}T${timeStr}`);
            
            if (!patientId || isNaN(datetime)) {
                showNotification("Lütfen tüm randevu bilgilerini (Hasta, Tarih, Saat) doğru girin.", "error");
                return;
            }
            
            const patientElement = form.elements['new-patient-id'].querySelector(`option[value="${patientId}"]`);
            const patientName = patientElement ? patientElement.dataset.name : 'Bilinmiyor';
            const doctorName = `${userProfile.name} ${userProfile.surname}`;

            try {
                await addDoc(appointmentCollectionRef(), {
                    patientId,
                    patientName, 
                    doctorId: userId,
                    doctorName: doctorName,
                    datetime,
                    notes,
                    fee: 0, 
                    procedure: '', 
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                });

                showNotification("Yeni randevu başarıyla oluşturuldu.", "success");
                form.reset();
                toggleNewAppointmentForm();

            } catch (error) {
                console.error("Randevu oluşturma hatası:", error);
                showNotification(`Randevu oluşturulurken hata: ${error.message}. Güvenlik kurallarını kontrol edin.`, "error");
            }
        };
        
        // --- YENİ DİNAMİK SLOT HESAPLAMA MANTIĞI ---

        // HH:MM stringini gece yarısından itibaren dakikaya çevirir
        const timeToMinutes = (time) => {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        };

        // Dakikayı HH:MM stringine çevirir
        const minutesToTime = (totalMinutes) => {
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        // Belirli bir doktorun belirli bir gündeki randevularını çeker
        const getAppointmentsForDoctorAndDay = async (doctorId, date) => {
            try {
                const startOfDay = new Date(date);
                startOfDay.setHours(0, 0, 0, 0);
                
                const endOfDay = new Date(date);
                endOfDay.setHours(23, 59, 59, 999);

                const q = query(
                    appointmentCollectionRef(), 
                    where("doctorId", "==", doctorId),
                    where("datetime", ">=", startOfDay),
                    where("datetime", "<=", endOfDay)
                );

                const snapshot = await getDocs(q);
                return snapshot.docs.map(d => ({ 
                    id: d.id, 
                    ...d.data(), 
                    datetime: d.data().datetime.toDate() 
                }));

            } catch (error) {
                console.error("Doktor randevularını çekerken hata:", error);
                return [];
            }
        };

        // Müsait slotları hesaplar (30 dakikalık varsayılır)
        const getAvailableSlots = (availability, existingAppointments) => {
            if (!availability || !availability.startTime || !availability.endTime) {
                return [];
            }

            const startMin = timeToMinutes(availability.startTime);
            const endMin = timeToMinutes(availability.endTime);
            const slotDuration = 30; // Randevu süresi 30 dakika varsayılmıştır

            let allSlots = [];
            const now = new Date();
            const todayDateStr = now.toLocaleDateString('en-CA');
            const selectedDateStr = document.getElementById('p-new-date').value;
            const isToday = selectedDateStr === todayDateStr;
            const nowMinutes = now.getHours() * 60 + now.getMinutes();

            for (let currentMin = startMin; currentMin < endMin; currentMin += slotDuration) {
                const slotEndMin = currentMin + slotDuration;
                
                // Çalışma saatini aşan slotları kes
                if (slotEndMin > endMin) continue;

                // Bugün için geçmiş saatleri atla
                if (isToday && currentMin < nowMinutes) continue;


                const slotStartTime = minutesToTime(currentMin);
                const slotEndTime = minutesToTime(slotEndMin);
                
                // Çakışma kontrolü
                const isConflict = existingAppointments.some(app => {
                    const appStartMin = app.datetime.getHours() * 60 + app.datetime.getMinutes();
                    const appEndMin = appStartMin + slotDuration; // Mevcut randevunun da 30 dk sürdüğünü varsayıyoruz
                    
                    // Çakışma, iki aralığın kesişimi varsa olur: (A.start < B.end) && (A.end > B.start)
                    return (currentMin < appEndMin) && (slotEndMin > appStartMin);
                });

                if (!isConflict) {
                    allSlots.push({ start: slotStartTime, end: slotEndTime });
                }
            }
            
            return allSlots;
        };

        // Saat seçeneklerini dinamik olarak doldur
        const updateTimeSlots = async () => {
            const doctorId = document.getElementById('p-new-doctor-id').value;
            const dateStr = document.getElementById('p-new-date').value;
            const timeSelect = document.getElementById('p-new-time');
            const statusDiv = document.getElementById('slot-status');
            
            timeSelect.innerHTML = '<option value="" disabled selected>-- Slot Aranıyor --</option>';
            statusDiv.innerHTML = '<p class="text-sm text-gray-500 flex items-center"><i class="fas fa-spinner fa-spin mr-2"></i> Müsait saatler hesaplanıyor...</p>';
            timeSelect.disabled = true;
            
            if (!doctorId || !dateStr) {
                statusDiv.innerHTML = '<p class="text-sm text-red-500">Lütfen hem doktoru hem de tarihi seçin.</p>';
                return;
            }

            const doctor = doctors.find(d => d.uid === doctorId);
            if (!doctor) {
                statusDiv.innerHTML = '<p class="text-sm text-red-500">Seçilen doktor bulunamadı.</p>';
                return;
            }
            
            // 1. Doktorun çalışma saatlerini çek
            let availability = null;
            try {
                const docRef = doc(db, getCollectionPath('doctorAvailability'), doctorId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    availability = docSnap.data();
                }
            } catch (error) {
                console.error("Doktor müsaitlik çekme hatası:", error);
            }
            
            if (!availability || !availability.startTime || !availability.endTime) {
                statusDiv.innerHTML = `<p class="text-sm text-red-500 font-semibold"><i class="fas fa-exclamation-circle mr-1"></i> Dr. ${doctor.name} ${doctor.surname}'nin çalışma saatleri ayarlanmamış.</p>`;
                return;
            }

            // 2. O günkü randevuları çek
            const existingAppointments = await getAppointmentsForDoctorAndDay(doctorId, dateStr);

            // 3. Müsait slotları hesapla
            const availableSlots = getAvailableSlots(availability, existingAppointments);

            timeSelect.innerHTML = '';
            if (availableSlots.length === 0) {
                timeSelect.innerHTML = '<option value="" disabled selected>-- Randevu Bulunamadı --</option>';
                statusDiv.innerHTML = `<p class="text-sm text-red-500 font-semibold"><i class="fas fa-calendar-times mr-1"></i> ${dateStr} tarihinde müsait slot bulunamadı.</p>`;
            } else {
                timeSelect.innerHTML = '<option value="" disabled selected>-- Randevu Saati Seçiniz (30 Dk) --</option>';
                availableSlots.forEach(slot => {
                    timeSelect.innerHTML += `<option value="${slot.start}">${slot.start} - ${slot.end} (${slotDuration} Dk)</option>`;
                });
                timeSelect.disabled = false;
                statusDiv.innerHTML = `<p class="text-sm text-green-600 font-semibold"><i class="fas fa-calendar-check mr-1"></i> ${availableSlots.length} müsait slot bulundu. Randevu saatini seçin.</p>`;
            }
        };

        window.updateTimeSlots = updateTimeSlots; // Global olarak erişilebilir yap

        const handlePatientNewAppointment = async (e) => {
            e.preventDefault();
            const form = e.target;
            const doctorId = form.elements['p-new-doctor-id'].value;
            const dateStr = form.elements['p-new-date'].value;
            const timeStr = form.elements['p-new-time'].value;
            const notes = form.elements['p-new-notes'].value.trim();
            
            if (!doctorId || !dateStr || !timeStr) {
                showNotification("Lütfen tüm alanları doldurun.", "error");
                return;
            }

            const datetime = new Date(`${dateStr}T${timeStr}`);
            
            if (isNaN(datetime) || datetime.getTime() < new Date().getTime()) {
                showNotification("Lütfen geçerli bir gelecek tarih ve saat seçin.", "error");
                return;
            }

            // YENİ: SON ÇAKIŞMA KONTROLÜ
            // Slot seçildikten hemen sonra başka bir kullanıcı aynı slotu almış olabilir.
            const existingAppointments = await getAppointmentsForDoctorAndDay(doctorId, dateStr);
            const selectedSlotStartMin = timeToMinutes(timeStr);
            const slotDuration = 30;
            const selectedSlotEndMin = selectedSlotStartMin + slotDuration;

            const isConflict = existingAppointments.some(app => {
                const appStartMin = app.datetime.getHours() * 60 + app.datetime.getMinutes();
                const appEndMin = appStartMin + slotDuration;
                
                // Çakışma kontrolü
                return (selectedSlotStartMin < appEndMin) && (selectedSlotEndMin > appStartMin);
            });

            if (isConflict) {
                showNotification("Seçtiğiniz saat dilimi maalesef başkası tarafından alındı. Lütfen listeden yeni bir slot seçin.", "error");
                // Slotları yeniden yükle
                updateTimeSlots();
                return;
            }
            // SON ÇAKIŞMA KONTROLÜ BİTTİ

            const doctorElement = form.elements['p-new-doctor-id'].querySelector(`option[value="${doctorId}"]`);
            const doctorName = doctorElement ? doctorElement.dataset.name : 'Bilinmiyor';

            const patientName = `${userProfile.name} ${userProfile.surname}`; 

            try {
                await addDoc(appointmentCollectionRef(), {
                    patientId: userId,
                    patientName: patientName, 
                    doctorId: doctorId,
                    doctorName: doctorName,
                    datetime: datetime, 
                    notes: notes || 'Hasta tarafından oluşturuldu.',
                    fee: 0, 
                    procedure: '', 
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                });

                showNotification("Randevu talebiniz başarıyla oluşturuldu.", "success");
                form.reset();
                updateTimeSlots(); // Randevu alındıktan sonra slotları güncelle

            } catch (error) {
                console.error("Hasta randevu oluşturma hatası:", error);
                showNotification(`Randevu oluşturulurken hata: ${error.message}. Güvenlik kurallarını kontrol edin.`, "error");
            }
        };

        // --- Randevu Düzenleme/Silme Fonksiyonları ---

        const renderModal = (contentHtml) => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = `
                <div id="app-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg transform transition-all duration-300 scale-100">
                        ${contentHtml}
                        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
            `;
            // Modal dışına tıklayınca kapatma
            document.getElementById('app-modal').addEventListener('click', (e) => {
                if (e.target.id === 'app-modal') {
                    closeModal();
                }
            });
        };

        window.closeModal = () => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = '';
        };

        const handleEditClick = (e) => {
            const id = e.currentTarget.dataset.id;
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return showNotification("Randevu bulunamadı.", "error");

            const patient = patients.find(p => p.uid === appointment.patientId);
            const patientName = patient ? `${patient.name} ${patient.surname}` : 'Bilinmiyor';

            const contentHtml = `
                <div class="p-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Randevu Düzenle: ${patientName}</h3>
                    <form id="edit-appointment-form" data-id="${id}" onsubmit="updateAppointment(event)">
                        <div class="space-y-4">
                            <div>
                                <label for="edit-procedure" class="block text-sm font-medium text-gray-700">Yapılan İşlem/Prosedür</label>
                                <textarea id="edit-procedure" rows="3" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" required placeholder="Hastaya uygulanan işlemi veya muayene sonucunu girin.">${appointment.procedure || ''}</textarea>
                            </div>
                            <div>
                                <label for="edit-fee" class="block text-sm font-medium text-gray-700">Ücret (TL)</label>
                                <input type="number" id="edit-fee" value="${appointment.fee || 0}" min="0" required class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="edit-notes" class="block text-sm font-medium text-gray-700">Doktor Notları</label>
                                <textarea id="edit-notes" rows="2" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">${appointment.notes || ''}</textarea>
                            </div>
                        </div>
                        <div class="mt-6 text-right">
                            <button type="submit" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg shadow-md transition-colors duration-200">
                                Kaydet ve Randevuyu Tamamla
                            </button>
                        </div>
                    </form>
                </div>
            `;
            renderModal(contentHtml);
        };
        
        window.handleEditClick = handleEditClick;

        const updateAppointment = async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.dataset.id;
            const procedure = form.elements['edit-procedure'].value.trim();
            const fee = parseFloat(form.elements['edit-fee'].value);
            const notes = form.elements['edit-notes'].value.trim();

            if (!procedure || isNaN(fee) || fee < 0) {
                showNotification("Lütfen geçerli bir işlem ve ücret girin.", "error");
                return;
            }

            try {
                const docRef = doc(db, getCollectionPath('appointments'), id);
                await updateDoc(docRef, {
                    procedure: procedure,
                    fee: fee,
                    notes: notes,
                    updatedAt: serverTimestamp(),
                });

                showNotification("Randevu bilgileri başarıyla güncellendi.", "success");
                closeModal();
            } catch (error) {
                console.error("Randevu güncelleme hatası:", error);
                showNotification(`Güncelleme sırasında hata: ${error.message}.`, "error");
            }
        };

        window.updateAppointment = updateAppointment;

        const handleDeleteClick = (e) => {
            const id = e.currentTarget.dataset.id;
            const appointment = appointments.find(a => a.id === id);
            if (!appointment) return;

            const patient = patients.find(p => p.uid === appointment.patientId);
            const patientName = patient ? `${patient.name} ${patient.surname}` : 'Bilinmiyor';

            const contentHtml = `
                <div class="p-6 text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Randevuyu Silme Onayı</h3>
                    <p class="text-gray-600 mb-6">
                        <span class="font-semibold">${patientName}</span> adlı hastanın ${appointment.datetime.toLocaleDateString('tr-TR')} tarihli randevusunu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.
                    </p>
                    <div class="flex justify-center space-x-4">
                        <button onclick="deleteAppointment('${id}')" class="px-6 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors duration-200">
                            Evet, Sil
                        </button>
                        <button onclick="closeModal()" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold rounded-lg transition-colors duration-200">
                            Hayır, Vazgeç
                        </button>
                    </div>
                </div>
            `;
            renderModal(contentHtml);
        };
        
        window.handleDeleteClick = handleDeleteClick;

        const deleteAppointment = async (id) => {
            try {
                const docRef = doc(db, getCollectionPath('appointments'), id);
                await deleteDoc(docRef);
                showNotification("Randevu başarıyla silindi.", "success");
                closeModal();
            } catch (error) {
                console.error("Randevu silme hatası:", error);
                showNotification(`Silme sırasında hata: ${error.message}.`, "error");
            }
        };
        
        window.deleteAppointment = deleteAppointment;


        const showNotification = (message, type) => {
            const container = document.getElementById('notification-container');
            if (!container) return;

            const bgColor = type === 'success' ? 'bg-primary' : 'bg-red-500';
            const html = `
                <div class="${bgColor} text-white px-4 py-3 rounded-xl shadow-2xl mb-4 transition-all duration-500 transform translate-y-0" role="alert" style="opacity: 1;">
                    <p class="font-bold">${type === 'success' ? 'Başarılı' : 'Hata'}</p>
                    <p class="text-sm">${message}</p>
                </div>
            `;
            container.innerHTML = html;
            
            setTimeout(() => {
                const element = container.querySelector('div');
                if (element) {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(-10px)';
                    setTimeout(() => container.innerHTML = '', 500);
                }
            }, 4000);
        };
        
        // Çıkış İşlemi
        document.addEventListener('click', async (e) => {
            if (e.target.id === 'logout-btn' || e.target.closest('#logout-btn')) {
                try {
                    await signOut(auth);
                    showNotification("Başarıyla çıkış yaptınız.", "success");
                } catch (error) {
                    console.error("Çıkış hatası:", error);
                    showNotification("Çıkış yaparken bir sorun oluştu.", "error");
                }
            }
        });

        // Uygulamayı başlat
        initializeFirebase();

    </script>
</body>
</html>
